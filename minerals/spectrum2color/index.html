<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width" /> <meta name="google-site-verification" content="riBpdQWal9w_jxf97W3pf6jUQs7jkzT3U2UOi9MZuPY" /> <title>From Spectrum to RGB Color - A practical protocol</title> <link rel="stylesheet" href="/css/w3.css"> <link rel="stylesheet" href="/css/main.css" type="text/css" /> <link rel="stylesheet" href="/css/pygments-default.css" type="text/css" /> <script src="https://kit.fontawesome.com/cf75892fab.js" crossorigin="anonymous"></script> <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,600' rel='stylesheet' type='text/css'> <style>body{font-family: 'Open Sans', sans-serif;}</style> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script> </head> <body> <header> <div id="title"> <h1>Simone Conti</h1> <h2>Personal website</h2> </div> <img src="/img/banners/research.png" alt="image banner" /> </header> <main> <article> <h1 id="from-spectrum-to-rgb-color---a-practical-protocol">From Spectrum to RGB Color - A practical protocol</h1> <hr /> <p>Before starting, converting a spectrum to a RGB color is a very complicated process which involve human physiology, perception, technological limits, and international standards. There is a lot of theory behind it. I am no expert in this field, and what follows are just some practices that looks like they are working for me. Any comment or improvement is welcome!</p> <p>One information that is possible to extract from an emission spectrum is the perceived color. Everybody knows that at different wavelengths correspond different colors of the rainbow: violet at 380–450nm, blue at 450–495nm, green at 495–570 nm, yellow at 570–590 nm, orange at 590–620 nm, and red at 620–750nm.</p> <p align="center"><a title="Gringer / Public domain" href="https://commons.wikimedia.org/wiki/File:Linear_visible_spectrum.svg"><img width="70%" alt="Linear visible spectrum" src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/Linear_visible_spectrum.svg/512px-Linear_visible_spectrum.svg.png" /></a></p> <p>If the emission spectrum would be composed of just one peak in one of these regions, the perceived color would be very simple to identify. In most cases though, the spectrum is composed by a number of peaks, some high and thin, some low and spread, often overlapped. What to do then? For example, the following is the fluorescence spectrum of a mineral (scapolite from Canada). The spectrum is composed by a broad band between 500nm (bright green) and 750nm (deep red), with few smaller peaks in between. What color is this?</p> <p align="center"><img src="/img/sample_emission_spectrum_scapolite.png" width="70%" /></p> <p>Human perceive colors thanks to the presence in the eye of three different cone cells (L, M, and S), each sensitive to a different range of wavelengths. When light enters the eye, the cones get stimulated differently based on the spectrum of that light. Then the three different stimuli from the three types of cone cells are put together to form the perceived color. What we can do is to reproduce this process, trying to simulate how a spectrum stimulates the three types of cone cells and then how this is perceived, or interpreted, by humans.</p> <p align="center"><img src="/img/cone_responses.png" width="70%" /></p> <p>Working directly with a color space defined by the cone responses is, unfortunately, not the best solution. Long story short, the International Commission on Illumination (CIE) developed in 1931 a set of “color matching functions” for a “standard observer”. These are three functions that, similarly to the three cone cells, respond, or “get stimulated”, differently from different wavelengths. By comparing the spectrum with the three color matching functions, three values X, Y and Z are calculated. These define a color space, and we could happily stop here.</p> <p>In a more mathematical form, the X, Y and Z values are computed as integral of the product between the spectrum and the three color matching functions. Calling the spectrum \(S(\lambda)\), where \(\lambda\) is the wavelength, and the matching functions \(\bar x(\lambda)\), \(\bar y(\lambda)\) and \(\bar z(\lambda)\), the XYZ values are computed as</p> <p>\[ X = \int S(\lambda) \bar x(\lambda) d\lambda \approx \sum_i S(\lambda_i) \bar x(\lambda_i) \]</p> <p>\[ Y = \int S(\lambda) \bar y(\lambda) d\lambda \approx \sum_i S(\lambda_i) \bar y(\lambda_i) \]</p> <p>\[ Z = \int S(\lambda) \bar z(\lambda) d\lambda \approx \sum_i S(\lambda_i) \bar z(\lambda_i) \]</p> <p>Given the arbitrary scale of the spectrum, it is nice at this point normalize the XYZ values such that their sum is one. Writing the integration and normalization steps into code we get:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">spectrum2xyz</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">xbar</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">ybar</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">zbar</span><span class="p">)</span>
    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">X</span><span class="o">+</span><span class="n">Y</span><span class="o">+</span><span class="n">Z</span>
    <span class="n">X</span> <span class="o">/=</span> <span class="n">XYZ</span>
    <span class="n">Y</span> <span class="o">/=</span> <span class="n">XYZ</span>
    <span class="n">Z</span> <span class="o">/=</span> <span class="n">XYZ</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span>
</code></pre></div></div> <p>(note: <code class="highlighter-rouge">sum(S*xbar)</code> is a vector operation: multiply the i-th element of S with the i-th element of xbar and sum all the results.)</p> <p>A last note on this point, the three color matching functions were defined in the 1931 numerically. Nowadays analytical approximations are available, which are much simpler to use. Here one:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">CIE_xyz_fit</span><span class="p">(</span><span class="n">wavel</span><span class="p">):</span>
    <span class="s">"""
        Simple Analytic Approximations to the CIE XYZ Color Matching Functions
        Chris Wyman, Peter-Pike Sloan, and Peter Shirley
        Journal of Computer Graphics Techniques, Vol. 2, No. 2, 2013
        http://jcgt.org/published/0002/02/01/
    """</span>
    <span class="k">def</span> <span class="nf">xFit_1931</span><span class="p">(</span><span class="n">wave</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="mf">442.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.0624</span> <span class="k">if</span> <span class="p">(</span><span class="n">wave</span><span class="o">&lt;</span><span class="mf">442.0</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0374</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="mf">599.8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.0264</span> <span class="k">if</span> <span class="p">(</span><span class="n">wave</span><span class="o">&lt;</span><span class="mf">599.8</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0323</span><span class="p">)</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="mf">501.1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.0490</span> <span class="k">if</span> <span class="p">(</span><span class="n">wave</span><span class="o">&lt;</span><span class="mf">501.1</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0382</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.362</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">t1</span><span class="o">*</span><span class="n">t1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.056</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">t2</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.065</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">t3</span><span class="o">*</span><span class="n">t3</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">yFit_1931</span><span class="p">(</span><span class="n">wave</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="mf">568.8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.0213</span> <span class="k">if</span> <span class="p">(</span><span class="n">wave</span><span class="o">&lt;</span><span class="mf">568.8</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0247</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="mf">530.9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.0613</span> <span class="k">if</span> <span class="p">(</span><span class="n">wave</span><span class="o">&lt;</span><span class="mf">530.9</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0322</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.821</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">t1</span><span class="o">*</span><span class="n">t1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.286</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">t2</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zFit_1931</span><span class="p">(</span><span class="n">wave</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="mf">437.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.0845</span> <span class="k">if</span> <span class="p">(</span><span class="n">wave</span><span class="o">&lt;</span><span class="mf">437.0</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0278</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="mf">459.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.0385</span> <span class="k">if</span> <span class="p">(</span><span class="n">wave</span><span class="o">&lt;</span><span class="mf">459.0</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0725</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.217</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">t1</span><span class="o">*</span><span class="n">t1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.681</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">t2</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">xfit</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span> <span class="n">xFit_1931</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wavel</span> <span class="p">])</span>
    <span class="n">yfit</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span> <span class="n">yFit_1931</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wavel</span> <span class="p">])</span>
    <span class="n">zfit</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span> <span class="n">zFit_1931</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wavel</span> <span class="p">])</span>
    <span class="k">return</span> <span class="n">xfit</span><span class="p">,</span> <span class="n">yfit</span><span class="p">,</span> <span class="n">zfit</span>
</code></pre></div></div> <p>These analycal expressions allow you to get the values of xbar, ybar and zbar for any waveleght you are interested in, making the calculation of X, Y, Z easier.</p> <p align="center"><img src="/img/cie_color_matching_functions.png" width="70%" /></p> <p>While uniquely defined, a color in the XYZ color space cannot be represented, as is, in a computer display or printed on a paper. The problem here is with the available technology and its limits. Color display and printing work in the RGB color space, which is easy and familiar to everybody: define three primary colors (Red, Green and Blue), and any other color is a mixture of these three.</p> <p>So, how to convert from XYZ to RGB? Easier said than done! First you have to define what is “white” in your XYZ color space, based on how you define which is your “standard illuminant”. Then you need to define what are “red”, “green” and “blue”; there at least a dozen definitions… Once you have done so, i.e. you picked the “standard Red Green Blue” (sRGB) with the “CIE Standard Illuminant D65”, you can simply compute the RGB values as a linear transformation of the XYZ values:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">R</span> <span class="o">=</span>  <span class="mf">3.2404542</span><span class="o">*</span><span class="n">X</span> <span class="o">-</span> <span class="mf">1.5371385</span><span class="o">*</span><span class="n">Y</span> <span class="o">-</span> <span class="mf">0.4985314</span><span class="o">*</span><span class="n">Z</span>
<span class="n">G</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9692660</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="mf">1.8760108</span><span class="o">*</span><span class="n">Y</span> <span class="o">+</span> <span class="mf">0.0415560</span><span class="o">*</span><span class="n">Z</span>
<span class="n">B</span> <span class="o">=</span>  <span class="mf">0.0556434</span><span class="o">*</span><span class="n">X</span> <span class="o">-</span> <span class="mf">0.2040259</span><span class="o">*</span><span class="n">Y</span> <span class="o">+</span> <span class="mf">1.0572252</span><span class="o">*</span><span class="n">Z</span>
</code></pre></div></div> <p>(these coefficients come from the definition of white and red, green and blue)</p> <p>These linear RGB values are still not the final result, but a non-linear gamma correction has to be applied. This is due to the fact that the brightness response of the human eye is not linear. It could happen at this point that one or more of the RGB values are negative, which cannot be. So we add “white” until the smallest one is zero. This can cause some values to become higher than 1, which again cannot be, so we normalize by the highest value. All together, this is (a possible) procedure to convert XYZ to RGB:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">xyz2rgb</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">adj</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">C</span><span class="o">&lt;</span><span class="mf">0.0031308</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">12.92</span> <span class="o">*</span> <span class="n">C</span>
        <span class="k">return</span> <span class="mf">1.055</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="o">**</span><span class="mf">0.41666</span><span class="p">)</span><span class="o">-</span><span class="mf">0.055</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">adj</span><span class="p">(</span> <span class="mf">3.2404542</span><span class="o">*</span><span class="n">X</span> <span class="o">-</span> <span class="mf">1.5371385</span><span class="o">*</span><span class="n">Y</span> <span class="o">-</span> <span class="mf">0.4985314</span><span class="o">*</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">adj</span><span class="p">(</span><span class="o">-</span><span class="mf">0.9692660</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="mf">1.8760108</span><span class="o">*</span><span class="n">Y</span> <span class="o">+</span> <span class="mf">0.0415560</span><span class="o">*</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">adj</span><span class="p">(</span> <span class="mf">0.0556434</span><span class="o">*</span><span class="n">X</span> <span class="o">-</span> <span class="mf">0.2040259</span><span class="o">*</span><span class="n">Y</span> <span class="o">+</span> <span class="mf">1.0572252</span><span class="o">*</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">minv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minv</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">-=</span> <span class="n">minv</span>
        <span class="n">G</span> <span class="o">-=</span> <span class="n">minv</span>
        <span class="n">B</span> <span class="o">-=</span> <span class="n">minv</span>
    <span class="n">maxv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">/=</span> <span class="n">maxv</span>
    <span class="n">G</span> <span class="o">/=</span> <span class="n">maxv</span>
    <span class="n">B</span> <span class="o">/=</span> <span class="n">maxv</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span>
</code></pre></div></div> <p>The function <code class="highlighter-rouge">adj</code> is the non-linear gamma correction.</p> <p>These are the final RGB values in the range [0-1]. Multiply them by 255 to get the common [0-255] range, or convert them to hexadecimal using something like:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">rgb2hex</span><span class="p">(</span><span class="n">rgb</span><span class="p">):</span>
    <span class="n">hexrgb</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rgb</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'#{:02x}{:02x}{:02x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="o">*</span><span class="n">hexrgb</span><span class="p">).</span><span class="n">upper</span><span class="p">()</span>
</code></pre></div></div> <p>Done!</p> <p>PS: Using this procedure on the scapolite fluorescence spectrum at the beginning, we get that the color is a yellow: <span style="background-color:#FFC900">#FFC900</span>, which quite matches the color obtained from a photo:</p> <p align="center"><img src="/img/minerals/121-02-scapolite-lwuv.jpg" width="70%" /></p> <h3 id="references">References</h3> <ul> <li><a href="https://en.wikipedia.org/wiki/CIE_1931_color_space">CIE color space from Wikipedia</a></li> <li><a href="https://en.wikipedia.org/wiki/SRGB">sRGB color space from Wikipedia</a></li> <li><a href="https://medium.com/hipster-color-science/a-beginners-guide-to-colorimetry-401f1830b65a">An introduction to the CIE colorimetry</a> Particularly interesting in this page is the description of the “Wright Guild Color Matching Experiments”</li> <li><a href="http://jcgt.org/published/0002/02/01/paper.pdf">Analytical approximations to the CIE color matching functions</a></li> <li><a href="https://ninedegreesbelow.com/photography/xyz-rgb.html">The full stuff in mode details</a></li> <li><a href="http://www.brucelindbloom.com/index.html?Eqn_XYZ_to_xyY.html">A lot of equation to convert between color spaces</a></li> </ul> <i>Last update: 15 April 2020</i> </article> </main> <aside> <!-- Contents --> <div class="sideblock"> <nav> <h3>Contents</h3> <hr /> <ul> <li><i class="fas fa-home fa-fw"></i> <a href="/">Home</a> </li> <li><i class="fas fa-user-circle fa-fw"></i> <a href="/cv/">CV</a> </li> <li><i class="fas fa-flask fa-fw"></i> <a href="/research/">Research Projects</a> </li> <li><i class="fas fa-book fa-fw"></i> <a href="/publications/">Publications</a> </li> <li><i class="fas fa-code fa-fw"></i> <a href="/programming/">C Programming</a> </li> <li><i class="fas fa-gem fa-fw"></i> <a href="/minerals/">Minerals</a> </li> <li><i class="fas fa-star fa-fw"></i> <a href="/mineralapp/">MineralApp</a> </li> <li><i class="fas fa-paper-plane fa-fw"></i> <a href="/stuff/">Stuff</a> </li> <li><i class="fas fa-envelope fa-fw"></i> <a href="/contact/">Contact</a> </li> </ul> </nav> </div> </aside> <footer> <p>Copyright &copy; 2015-2020 Simone Conti. All rights reserved.</p> </footer> </body> </html>
